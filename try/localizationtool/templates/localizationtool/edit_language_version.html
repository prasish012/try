{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Edit Translations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background: #eef1f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .topbar { background: #1f2937; color: white; padding: 12px 24px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .left-panel { background: #ffffff; height: calc(100vh - 50px); overflow-y: auto; border-right: 1px solid #e5e7eb; }
        .right-panel { height: calc(100vh - 50px); padding: 35px; background: #f9fafb; }
        .search-container { padding: 18px; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
        .search-input { border-radius: 50px; padding-left: 45px; font-size: 14px; border: 1px solid #d1d5db; }
        .search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .search-icon { position: absolute; left: 28px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .list-header { display: flex; font-weight: 600; font-size: 12px; padding: 12px 18px; border-bottom: 1px solid #e5e7eb; background: #fafafa; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; }
        .entry-row { display: flex; padding: 14px 18px; font-size: 13px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: all 0.15s ease; }
        .entry-row:hover { background: #eef2ff; }
        .entry-row.active { background: #3b82f6; color: white; }
        .entry-col { width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #sourceBox { background: white !important; border: 1px solid #e5e7eb !important; border-radius: 10px; font-size: 14px; min-height: 80px; padding: 12px; }
        textarea { min-height: 200px; resize: vertical; border-radius: 10px !important; border: 1px solid #d1d5db !important; font-size: 14px !important; padding: 12px; }
        textarea:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 3px rgba(59,130,246,0.2) !important; }
        .btn-primary, .btn-success { border: none; border-radius: 8px; padding: 10px 20px; font-weight: 500; }
    </style>
</head>

<body>

<div class="topbar">
    <div><a href="{% url 'view_and_edit_translations' folder_name %}" class="go-back">‚Üê Go Back</a></div>
    <div>Language: <strong>{{ lang_code }}</strong> | Version: <strong>{{ version }}</strong></div>
</div>

<div class="container-fluid p-0">
    <div class="row g-0">

        <!-- LEFT PANEL -->
        <div class="col-md-6 left-panel">

            <div class="search-container">
                <div class="position-relative">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="form-control search-input" placeholder="Search strings..." onkeyup="filterEntries()">
                </div>
            </div>

            <div class="list-header">
                <div class="entry-col">Source</div>
                <div class="entry-col">Translation</div>
            </div>

            <div id="entriesList">
                {% for entry in entries %}
                <div class="entry-row" onclick="selectEntry(this)" 
                     data-msgid="{{ entry.msgid|escapejs }}"
                     data-msgstr="{{ entry.msgstr|escapejs }}">
                    <div class="entry-col">{{ entry.msgid }}</div>
                    <div class="entry-col text-muted">{{ entry.msgstr|default:"‚Äî" }}</div>
                </div>
                {% endfor %}
            </div>

        </div>

        <!-- RIGHT PANEL -->
        <div class="col-md-6 right-panel">

            <h5>Source Text</h5>
            <div id="sourceBox" class="mb-3 p-3 border rounded bg-light">Select a string from the left</div>

            <h5 class="mt-3">Translation</h5>
            <textarea class="form-control mb-3" id="translationBox"></textarea>

            <div class="mt-3">
                <button class="btn btn-success me-2" onclick="saveCurrentTranslation()">üíæ Save This Translation</button>
                <button class="btn btn-primary" onclick="checkTranslation()">üîç Check</button>
            </div>

            <div id="actionResult" class="mt-3"></div>
            <div id="checkResult" class="mt-2"></div>

        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Strong Decoder for \u0026ldquo; etc.
function decodeUnicode(text) {
    if (!text) return '';

    // Decode JavaScript escapes (\u0026, \u201C, etc.)
    text = text.replace(/\\u([0-9a-fA-F]{4})/gi, (match, hex) => {
        return String.fromCharCode(parseInt(hex, 16));
    });

    // Decode HTML entities (&ldquo;, &copy;, etc.)
    text = text.replace(/&(#\d+);/g, (match, num) => String.fromCharCode(parseInt(num.substring(1))));
    text = text.replace(/&([a-zA-Z]+);/g, (match, entity) => {
        const map = {'ldquo':'‚Äú','rdquo':'‚Äù','lsquo':'‚Äò','rsquo':'‚Äô','copy':'¬©','reg':'¬Æ','trade':'‚Ñ¢','amp':'&'};
        return map[entity] || match;
    });

    return text;
}

function filterEntries() {
    const filter = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.entry-row').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
}

function selectEntry(row) {
    document.querySelectorAll('.entry-row').forEach(r => r.classList.remove('active'));
    row.classList.add('active');

    const msgid = decodeUnicode(row.getAttribute('data-msgid'));
    const msgstr = decodeUnicode(row.getAttribute('data-msgstr'));

    document.getElementById('sourceBox').innerText = msgid;
    document.getElementById('translationBox').value = msgstr;
}

function checkTranslation() {
    const resultDiv = document.getElementById('checkResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Checking format...</div>';

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('po_path', '{{ po_path }}');

    fetch('/check-validation/', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
        } else if (data.status === 'warning') {
            let html = `<div class="alert alert-warning">${data.message}<ul class="mb-0">`;
            data.warnings.forEach(w => html += `<li>${w}</li>`);
            html += '</ul></div>';
            resultDiv.innerHTML = html;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(() => resultDiv.innerHTML = `<div class="alert alert-danger">Server error.</div>`);
}

function saveCurrentTranslation() {
    const activeRow = document.querySelector('.entry-row.active');
    const resultDiv = document.getElementById('actionResult');
    const newText = document.getElementById('translationBox').value.trim();

    if (!activeRow) {
        resultDiv.innerHTML = `<div class="alert alert-warning">Please select a string first.</div>`;
        return;
    }

    resultDiv.innerHTML = '<div class="alert alert-info">Saving...</div>';

    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('po_path', '{{ po_path }}');
    formData.append('msgid', activeRow.getAttribute('data-msgid'));
    formData.append('msgstr', newText);

    fetch('/save-translation/', { method: 'POST', body: formData })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            activeRow.querySelector('.entry-col.text-muted').innerText = newText || "‚Äî";
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        }
    })
    .catch(() => resultDiv.innerHTML = `<div class="alert alert-danger">Failed to save.</div>`);
}
</script>

</body>
</html>