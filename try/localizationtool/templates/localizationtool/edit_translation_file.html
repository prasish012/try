<!-- <!DOCTYPE html>
<html>
<head>
    <title>Edit Translations - {{ folder_name }}</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        select, button { margin: 10px 0; padding: 8px; }
        textarea { width: 100%; height: 80px; font-family: monospace; }
        .entry { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
        .save-btn { background: #007cba; color: white; padding: 10px 20px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h2>Editing: <strong>{{ folder_name }}</strong></h2>

    <label for="lang-select">Select Language:</label>
    <select id="lang-select" onchange="window.location.href='?lang=' + this.value">
        {% for lang in available_langs %}
            <option value="{{ lang }}" {% if lang == current_lang %}selected{% endif %}>
                {{ lang|upper }}
            </option>
        {% endfor %}
    </select>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="translations" id="translations-data">

        <div id="translations">
            {% for msgid, data in translations.items %}
            <div class="entry">
                <strong>msgid:</strong> {{ data.msgid|truncatechars:100 }}<br>
                <strong>msgstr:</strong><br>
                <textarea name="trans_{{ forloop.counter }}">{{ data.msgstr }}</textarea>
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="save-btn">Save & Regenerate .mo</button>
    </form>

    <script>
        document.querySelector('form').onsubmit = function() {
            const translations = {};
            document.querySelectorAll('.entry').forEach(el => {
                const msgid = el.querySelector('strong').nextSibling.textContent.trim();
                const msgstr = el.querySelector('textarea').value;
                translations[msgid] = { msgid, msgstr };
            });
            document.getElementById('translations-data').value = JSON.stringify(translations);
        };
    </script>
</body>
</html> -->
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <h2>Editing: {{ lang_name }} ({{ lang_code }})</h2>
    <a href="{% url 'view_translations' folder_name %}" class="btn btn-secondary mb-3">Back</a>

    <form id="translation-form" method="post" action="{% url 'save_translation' %}">
        {% csrf_token %}
        <input type="hidden" name="po_path" value="{{ po_path }}">

        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Original (msgid)</th>
                        <th>Translation (msgstr)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                        <tr>
                            <td>
                                <code>{{ entry.msgid }}</code>
                                {% if entry.msgid_plural %}
                                    <br><small class="text-muted">Plural: {{ entry.msgid_plural }}</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if entry.is_plural %}
                                    {% for i, plural in entry.msgstr_plural.items %}
                                        <div class="mb-1">
                                            <small>Form {{ i }}:</small><br>
                                            <input type="text" name="msgstr_plural_{{ entry.msgid|slugify }}_{{ i }}"
                                                   value="{{ plural }}" class="form-control form-control-sm">
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <input type="text" name="msgstr_{{ entry.msgid|slugify }}"
                                           value="{{ entry.msgstr }}" class="form-control form-control-sm">
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-primary">Save & Compile .mo</button>
    </form>

    <div id="save-status" class="mt-3"></div>
</div>

<script>
document.getElementById('translation-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    fetch("{% url 'save_translation' %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(r => r.json())
    .then(data => {
        const status = document.getElementById('save-status');
        if (data.success) {
            status.innerHTML = `<div class="alert alert-success">Saved ${data.updated} strings! PO: ${data.po} | MO: ${data.mo}</div>`;
        } else {
            status.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    });
});
</script>
{% endblock %}